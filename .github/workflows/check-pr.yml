name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: check-pr-${{ github.ref }}
  cancel-in-progress: true

env:
  WORKING_DIR: apps

jobs:
  analyze-and-format:
    name: Dart Analysis and Format Check
    runs-on: ubuntu-24.04
    needs: check-file-changes
    if: needs.check-file-changes.outputs.dart_changed > 0

    steps:
      # https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Flutter with FVM
        uses: ./.github/actions/setup-flutter

      - name: Run melos analyze
        run: melos run analyze

      - name: Run melos test
        run: melos run test

      - name: Check melos format
        run: melos run ci:format

  check-file-changes:
    name: Check File Changes
    runs-on: ubuntu-24.04
    outputs:
      dart_changed: ${{ steps.check_changes.outputs.dart_changed }}
      i18n_files_exist: ${{ steps.check_i18n_files.outputs.files_exists }}
      yml_changed: ${{ steps.check_changes.outputs.yml_changed }}
      yaml_changed: ${{ steps.check_changes.outputs.yaml_changed }}
      md_changed: ${{ steps.check_changes.outputs.md_changed }}
      i18n_changed: ${{ steps.check_changes.outputs.i18n_changed }}

    steps:
      # https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      # Check for i18n files existence
      - name: Check for i18n files existence
        id: check_i18n_files
        uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6 # v3.0.0
        with:
          files: 'apps/assets/i18n/*.i18n.json'

      # Check for file changes
      - name: Check for file changes
        id: check_changes
        uses: ./.github/actions/check-changes
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}

  i18n-validation:
    name: i18n Validation
    runs-on: ubuntu-24.04
    needs: check-file-changes
    if: needs.check-file-changes.outputs.i18n_files_exist == 'true' && needs.check-file-changes.outputs.i18n_changed > 0

    steps:
      # https://github.com/actions/checkout  ss
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Flutter with FVM
        uses: ./.github/actions/setup-flutter

      - name: Run slang analyze
        run: melos run analyze:slang

  lint-yaml-markdown:
    name: Lint YAML and Markdown
    runs-on: ubuntu-24.04
    needs: check-file-changes
    if: needs.check-file-changes.outputs.yml_changed > 0 || needs.check-file-changes.outputs.yaml_changed > 0 || needs.check-file-changes.outputs.md_changed > 0

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.17'

      - name: Install dependencies
        run: bun install

      - name: Run Prettier check
        run: bun run ci:check

name: Auto Tag PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: auto-tag-${{ github.ref }}
  cancel-in-progress: true

jobs:
  auto-tag:
    name: Auto Tag PR by Changed Workspace
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check for file changes and determine workspace
        id: check_changes
        uses: ./.github/actions/check-changes
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}

      - name: Auto tag workspaces dynamically
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const labelsToAdd = [];

            // Get changed workspaces from check-changes action
            const changedWorkspaces = '${{ steps.check_changes.outputs.changed_workspaces }}';

            if (changedWorkspaces && changedWorkspaces.trim() !== '') {
              // Add general workspace label
              labelsToAdd.push('workspace');
              
              // Split and add specific workspace labels
              const workspaces = changedWorkspaces.trim().split(' ');
              workspaces.forEach(workspace => {
                if (workspace) {
                  labelsToAdd.push(workspace);
                }
              });
              
              console.log(`Detected changed workspaces: ${workspaces.join(', ')}`);
            }

            if (labelsToAdd.length > 0) {
              console.log(`Adding labels: ${labelsToAdd.join(', ')}`);
              
              // Create labels that don't exist
              for (const label of labelsToAdd) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: label === 'workspace' ? '1d76db' : '0969da'
                  });
                } catch (error) {
                  // Label already exists, which is fine
                  if (error.status !== 422) {
                    console.log(`Error creating label ${label}: ${error.message}`);
                  }
                }
              }
              
              // Add labels to PR
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labelsToAdd
              });
            } else {
              console.log('No workspace changes detected, no labels added');
            }
